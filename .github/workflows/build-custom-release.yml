name: Build Custom MinIO Release

on:
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: "Upstream ref (tag/branch/commit) from minio/minio"
        required: true
        default: "master"

env:
  MINIO_UPSTREAM_REPO: minio/minio

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout upstream MinIO
        uses: actions/checkout@v4
        with:
          repository: ${{ env.MINIO_UPSTREAM_REPO }}
          ref: ${{ inputs.upstream_ref }}
          path: minio-src
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache: true

      - name: Apply custom patches
        run: |
          set -euo pipefail
          if compgen -G "patches/*.patch" > /dev/null; then
            cd minio-src
            echo "Applying patches..."
            git apply ../patches/*.patch
          else
            echo "No patches found"
          fi

      # - name: Run unit tests
      #   working-directory: minio-src
      #   run: |
      #     set -euo pipefail
      #     MINIO_API_REQUESTS_MAX=10000 CGO_ENABLED=0 go test -v -tags kqueue,dev ./...

      # Uncomment below for race condition testing (adds ~20 min)
      # - name: Run race tests
      #   working-directory: minio-src
      #   run: |
      #     set -euo pipefail
      #     export GORACE="history_size=7"
      #     export MINIO_API_REQUESTS_MAX=10000
      #     for d in $(go list ./...); do
      #       CGO_ENABLED=1 go test -v -race --timeout 100m "$d"
      #     done

      - name: Build binary
        working-directory: minio-src
        run: |
          set -euo pipefail
          export MINIO_RELEASE=RELEASE
          LDFLAGS="$(env GOOS= GOARCH= go run buildscripts/gen-ldflags.go)"

          # Extract release tag from LDFLAGS
          RELEASE_TAG=$(echo "$LDFLAGS" | grep -oP 'cmd\.ReleaseTag=\K[^ ]+')
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV
          echo "Release: ${RELEASE_TAG}"

          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -trimpath -tags kqueue -ldflags "$LDFLAGS" -o minio .

          # Prepare artifacts
          cp -f ./minio "minio-amd64.${RELEASE_TAG}"
          sha256sum "minio-amd64.${RELEASE_TAG}" | awk '{print $1"  minio"}' > "minio-amd64.${RELEASE_TAG}.sha256sum"

          # Download mc
          curl -fsSL "https://dl.min.io/client/mc/release/linux-amd64/mc" -o "mc-amd64"
          chmod +x "mc-amd64"
          sha256sum "mc-amd64" | awk '{print $1"  mc"}' > "mc-amd64.sha256sum"

      - name: Run integration tests
        working-directory: minio-src
        run: |
          set -euo pipefail
          bash buildscripts/verify-build.sh

      - name: Run healing tests
        working-directory: minio-src
        run: |
          set -euo pipefail
          bash buildscripts/verify-healing.sh

      - name: Run empty erasure set healing tests
        working-directory: minio-src
        run: |
          set -euo pipefail
          bash buildscripts/verify-healing-empty-erasure-set.sh

      - name: Run healing with root disks tests
        working-directory: minio-src
        run: |
          set -euo pipefail
          bash buildscripts/verify-healing-with-root-disks.sh

      - name: Run multipart quorum tests
        working-directory: minio-src
        run: |
          set -euo pipefail
          bash buildscripts/multipart-quorum-test.sh

      - name: Run disable root tests
        working-directory: minio-src
        run: |
          set -euo pipefail
          bash buildscripts/disable-root.sh

      - name: Run timeout tests
        working-directory: minio-src
        run: |
          set -euo pipefail
          bash buildscripts/test-timeout.sh

      - name: Build Docker image
        working-directory: minio-src
        run: |
          set -euo pipefail
          docker build \
            -f ../Dockerfile.release.local \
            --build-arg TARGETARCH=amd64 \
            --build-arg RELEASE="${{ env.RELEASE_TAG }}" \
            -t "minio:${{ env.RELEASE_TAG }}-amd64" .

      - name: Test Docker image - smoke test
        run: |
          set -euo pipefail
          cid=$(docker run -d --rm \
            -p 9000:9000 -p 9001:9001 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            "minio:${{ env.RELEASE_TAG }}-amd64" server /data --console-address ":9001")

          for i in $(seq 1 60); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:9000/minio/health/ready || true)
            [ "$code" = "200" ] && break
            [ "$i" = "60" ] && { docker logs "$cid"; exit 1; }
            sleep 1
          done

          curl -fsSL "https://dl.min.io/client/mc/release/linux-amd64/mc" -o /tmp/mc
          chmod +x /tmp/mc
          /tmp/mc alias set local http://127.0.0.1:9000 minioadmin minioadmin
          /tmp/mc mb local/testbucket
          echo "test" | /tmp/mc pipe local/testbucket/test.txt
          /tmp/mc cat local/testbucket/test.txt | grep -q test

          docker stop "$cid" >/dev/null
          echo "✓ Smoke tests passed"

      - name: Test Docker image - erasure mode (Docker Compose)
        run: |
          set -euo pipefail
          cat > /tmp/docker-compose.yml << 'EOF'
          version: '3.7'
          services:
            minio1:
              image: "minio:${{ env.RELEASE_TAG }}-amd64"
              ports:
                - "9000:9000"
              environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin
              command: server http://minio{1...4}/data --address ":9000"
              volumes:
                - /tmp/minio1:/data
              networks:
                - minio-net
            minio2:
              image: "minio:${{ env.RELEASE_TAG }}-amd64"
              ports:
                - "9001:9000"
              environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin
              command: server http://minio{1...4}/data --address ":9000"
              volumes:
                - /tmp/minio2:/data
              networks:
                - minio-net
            minio3:
              image: "minio:${{ env.RELEASE_TAG }}-amd64"
              ports:
                - "9002:9000"
              environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin
              command: server http://minio{1...4}/data --address ":9000"
              volumes:
                - /tmp/minio3:/data
              networks:
                - minio-net
            minio4:
              image: "minio:${{ env.RELEASE_TAG }}-amd64"
              ports:
                - "9003:9000"
              environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin
              command: server http://minio{1...4}/data --address ":9000"
              volumes:
                - /tmp/minio4:/data
              networks:
                - minio-net
          networks:
            minio-net:
              driver: bridge
          EOF

          docker-compose -f /tmp/docker-compose.yml up -d
          sleep 10

          # Test erasure mode
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:9000/minio/health/ready || true)
            [ "$code" = "200" ] && break
            [ "$i" = "30" ] && { echo "Timeout waiting for MinIO"; exit 1; }
            sleep 1
          done

          curl -fsSL "https://dl.min.io/client/mc/release/linux-amd64/mc" -o /tmp/mc
          chmod +x /tmp/mc
          /tmp/mc alias set erosure http://127.0.0.1:9000 minioadmin minioadmin
          /tmp/mc mb erosure/testbucket
          echo "erasure-test" | /tmp/mc pipe erosure/testbucket/test.txt
          /tmp/mc cat erosure/testbucket/test.txt | grep -q erasure-test

          docker-compose -f /tmp/docker-compose.yml down
          echo "✓ Erasure mode tests passed"

