name: MinIO Build

on:
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: "Upstream ref (tag/branch/commit) from minio/minio"
        required: true
        default: "master"

env:
  MINIO_UPSTREAM_REPO: minio/minio
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/minio

jobs:
  build_test_docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    #   - name: Checkout this repo
    #     uses: actions/checkout@v4
    #     with:
    #       fetch-depth: 0

      - name: Checkout upstream MinIO
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.ref }}
          path: minio-src
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache: true

      - name: Apply patches (optional)
        run: |
          set -euo pipefail
          if compgen -G "patches/*.patch" > /dev/null; then
            cd minio-src
            git apply ../patches/*.patch
          else
            echo "No patches/*.patch found, skip."
          fi

      - name: Unit tests
        working-directory: minio-src
        run: |
          go test ./...

      - name: Build minio (linux/amd64)
        working-directory: minio-src
        run: |
          # Чтобы версия была RELEASE.* вместо DEVELOPMENT.*
          export MINIO_RELEASE=RELEASE

          # ВАЖНО: ldflags генерим на host (без GOOS/GOARCH)
          LDFLAGS="$(env GOOS= GOARCH= go run buildscripts/gen-ldflags.go)"

          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 \
            go build -trimpath -tags kqueue -ldflags "$LDFLAGS" -o minio .

          ./minio --version || true

      - name: Binary smoke test (resolve-right-versions)
        working-directory: minio-src
        run: |
          sudo apt-get update
          sudo apt-get install -y git
          bash buildscripts/resolve-right-versions.sh

      - name: Docker build (amd64) via make
        working-directory: minio-src
        run: |
          TAG=minio-under-test:amd64 make docker

      - name: Docker smoke test
        run: |
          set -euo pipefail
          cid=$(docker run -d --rm \
            -p 9000:9000 -p 9001:9001 \
            -e MINIO_ROOT_USER=minio \
            -e MINIO_ROOT_PASSWORD=minio123 \
            minio-under-test:amd64 server /data --console-address ":9001")

          for i in $(seq 1 60); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:9000/minio/health/ready || true)
            if [ "$code" = "200" ]; then
              break
            fi
            if [ "$i" = "60" ]; then
              echo "MinIO not ready. Logs:"
              docker logs "$cid" || true
              exit 1
            fi
            sleep 1
          done

          curl -fsS http://127.0.0.1:9000/minio/health/live >/dev/null
          docker stop "$cid" >/dev/null

