name: MinIO Build

on:
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: "Upstream ref (tag/branch/commit) from minio/minio"
        required: true
        default: "master"

env:
  MINIO_UPSTREAM_REPO: minio/minio

jobs:
  build_test_docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout upstream MinIO
        uses: actions/checkout@v4
        with:
          repository: ${{ env.MINIO_UPSTREAM_REPO }}
          ref: ${{ inputs.upstream_ref }}
          path: minio-src
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache: true

      - name: Apply patches (optional)
        run: |
          set -euo pipefail
          if compgen -G "patches/*.patch" > /dev/null; then
            cd minio-src
            git apply ../patches/*.patch
          else
            echo "No patches/*.patch found, skip."
          fi

      - name: Unit tests
        working-directory: minio-src
        run: |
          go test ./...

      - name: Build minio (linux/amd64)
        working-directory: minio-src
        run: |
          set -euo pipefail
          export MINIO_RELEASE=RELEASE
          LDFLAGS="$(env GOOS= GOARCH= go run buildscripts/gen-ldflags.go)"
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 \
            go build -trimpath -tags kqueue -ldflags "$LDFLAGS" -o minio .
          ./minio --version

      - name: Prepare + sign artifacts (minio + mc)
        working-directory: minio-src
        env:
          MINISIGN_PRIVATE_KEY: ${{ secrets.MINISIGN_PRIVATE_KEY }}
          MINISIGN_PASSPHRASE: ${{ secrets.MINISIGN_PASSPHRASE }}
        run: |
          set -euo pipefail
          : "${MINISIGN_PRIVATE_KEY:?Missing secret MINISIGN_PRIVATE_KEY}"
          : "${MINISIGN_PASSPHRASE:?Missing secret MINISIGN_PASSPHRASE}"

          export GOPATH=/tmp/gopath
          export PATH="$PATH:$GOPATH/bin"
          go install aead.dev/minisign/cmd/minisign@v0.2.1

          RELEASE_TAG="$(./minio --version | head -n1 | awk '{print $3}')"
          echo "RELEASE_TAG=${RELEASE_TAG}" >> "$GITHUB_ENV"

          printf "%s" "${MINISIGN_PRIVATE_KEY}" > minisign.key
          chmod 600 minisign.key
          printf "%s\n" "${MINISIGN_PASSPHRASE}" > .passphrase
          chmod 600 .passphrase

          # ---- minio artifacts: minio-${TARGETARCH}.${RELEASE}* ----
          cp -f ./minio "minio-amd64.${RELEASE_TAG}"

          sha256sum "minio-amd64.${RELEASE_TAG}" | awk '{print $1"  minio"}' > "minio-amd64.${RELEASE_TAG}.sha256sum"

          minisign -S -m "minio-amd64.${RELEASE_TAG}" -s minisign.key < .passphrase

          # ---- mc artifacts: mc-${TARGETARCH}* ----
          curl -fsSL "https://dl.min.io/client/mc/release/linux-amd64/mc" -o "mc-amd64"
          chmod +x "mc-amd64"

          sha256sum "mc-amd64" | awk '{print $1"  mc"}' > "mc-amd64.sha256sum"

          minisign -S -m "mc-amd64" -s minisign.key < .passphrase

          # sanity
          test -f "minio-amd64.${RELEASE_TAG}.minisig"
          test -f "mc-amd64.minisig"
          ls -la minio-amd64.${RELEASE_TAG}* mc-amd64*

      - name: Docker build (release.local, amd64)
        working-directory: minio-src
        env:
          MINISIGN_PUBKEY: ${{ secrets.MINISIGN_PUBKEY }}
        run: |
          set -euo pipefail
          : "${MINISIGN_PUBKEY:?Missing secret MINISIGN_PUBKEY}"

          docker build \
            -f ../Dockerfile.release.local \
            --build-arg TARGETARCH=amd64 \
            --build-arg RELEASE="${RELEASE_TAG}" \
            --build-arg MINISIGN_PUBKEY="${MINISIGN_PUBKEY}" \
            -t "minio-under-test:${RELEASE_TAG}-amd64" .

      - name: Docker smoke test
        run: |
          set -euo pipefail
          cid=$(docker run -d --rm \
            -p 9000:9000 -p 9001:9001 \
            -e MINIO_ROOT_USER=minio \
            -e MINIO_ROOT_PASSWORD=minio123 \
            "minio-under-test:${RELEASE_TAG}-amd64" server /data --console-address ":9001")

          for i in $(seq 1 60); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:9000/minio/health/ready || true)
            if [ "$code" = "200" ]; then break; fi
            if [ "$i" = "60" ]; then
              echo "MinIO not ready. Logs:"
              docker logs "$cid" || true
              exit 1
            fi
            sleep 1
          done

          curl -fsSL "https://dl.min.io/client/mc/release/linux-amd64/mc" -o /tmp/mc
          chmod +x /tmp/mc

          /tmp/mc alias set local http://127.0.0.1:9000 minio minio123
          /tmp/mc mb local/testbucket

          echo "hello" > /tmp/hello.txt
          /tmp/mc cp /tmp/hello.txt local/testbucket/hello.txt
          /tmp/mc cat local/testbucket/hello.txt | grep -q "hello"

          curl -fsS http://127.0.0.1:9000/minio/health/live >/dev/null
          docker stop "$cid" >/dev/null
