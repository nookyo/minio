FROM golang:1.24-alpine AS build

ARG TARGETARCH
ARG RELEASE

ENV GOPATH=/go
ENV CGO_ENABLED=0

WORKDIR /build

RUN apk add -U --no-cache ca-certificates bash && \
    go install aead.dev/minisign/cmd/minisign@v0.2.1

#   minio-amd64.<RELEASE>
#   minio-amd64.<RELEASE>.minisig
#   minio-amd64.<RELEASE>.sha256sum

COPY minio-${TARGETARCH}.${RELEASE} /go/bin/minio
COPY minio-${TARGETARCH}.${RELEASE}.minisig /go/bin/minio.minisig
COPY minio-${TARGETARCH}.${RELEASE}.sha256sum /go/bin/minio.sha256sum

COPY mc-${TARGETARCH} /go/bin/mc
COPY mc-${TARGETARCH}.minisig /go/bin/mc.minisig
COPY mc-${TARGETARCH}.sha256sum /go/bin/mc.sha256sum

RUN cd /go/bin && sha256sum -c minio.sha256sum && sha256sum -c mc.sha256sum

ARG MINISIGN_PUBKEY
RUN minisign -Vqm /go/bin/minio -x /go/bin/minio.minisig -P "${MINISIGN_PUBKEY}" && \
    minisign -Vqm /go/bin/mc    -x /go/bin/mc.minisig    -P "${MINISIGN_PUBKEY}"

FROM alpine:3.22

ARG RELEASE

LABEL name="MinIO-Custom" \
      vendor="Custom Build" \
      version="${RELEASE}" \
      summary="MinIO with custom patches - S3-compatible object storage"

RUN apk add -U --no-cache ca-certificates bash

ENV MINIO_ACCESS_KEY_FILE=access_key \
    MINIO_SECRET_KEY_FILE=secret_key \
    MINIO_ROOT_USER_FILE=access_key \
    MINIO_ROOT_PASSWORD_FILE=secret_key \
    MINIO_KMS_SECRET_KEY_FILE=kms_master_key \
    MINIO_CONFIG_ENV_FILE=config.env \
    MC_CONFIG_DIR=/tmp/.mc

COPY --from=build /go/bin/minio* /usr/bin/
COPY --from=build /go/bin/mc* /usr/bin/

COPY CREDITS /licenses/CREDITS
COPY LICENSE /licenses/LICENSE
COPY dockerscripts/docker-entrypoint.sh /usr/bin/docker-entrypoint.sh

EXPOSE 9000
VOLUME ["/data"]

ENTRYPOINT ["/usr/bin/docker-entrypoint.sh"]
CMD ["minio"]
